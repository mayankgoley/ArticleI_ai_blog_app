<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Blog Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <style>
        .loader {
            border: 8px solid #706b6b;
            border-top : 8px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;

            position:fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            display: none;
        }

        .overlay {
            position:fixed; 
            inset:0;
            background:rgba(255,255,255,.7);
            z-index:9998;
            display:none;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

    </style>
</head>
<body class="flex flex-col min-h-screen bg-gray-100 font-sans antialiased">
    <!-- Navigation Bar -->
    <nav class="bg-blue-800 p-4 text-white flex justify-between">
        <!-- Left side -->
        <div>
            <a href="/" class="text-3xl font-bold">Article I</a>
        </div>
        <!-- Right side -->
        <div class="space-x-4">
            {% if user.is_authenticated %}
                <a href="/all-blogs" class="text-white hover:underline">My Articles</a>
                <a href="/logout" class="text-white hover:underline">Logout</a>
            {% else %}
                <a href="/login" class="text-white hover:underline">Login</a>
                <a href="/signup" class="text-white hover:underline">Signup</a>
            {% endif %}
        </div>
    </nav>
    <br>
    <br>

    <!--Main-->
    <div class="flex-grow container mx-auto mt-10 px-4 sm:px-0">
        <div class="max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-md transition-transform transform hover:scale-105 flex flex-col">
            <!-- Introduction Section -->
            <div class="text-center">
                <h2 class="text-2xl font-semibold mb-4">Welcome to ArticleI - The Intelligent Article Generator.</h2>
                <p class="text-gray-700">Turn any video into a ready-to-publish article. From voice to words-powered by AI. Simply enter the link to the Youtube video below and let the AI create the content for you!</p>
            </div>
            <br>
            <!-- Input Section -->
            <div>
                <h2 class="text-xl mb-4 font-semibold text-center">Enter Youtube video Link</h2>
                <div class="space-y-4">
                    <!-- URL Input -->
                    <div class="flex space-x-4">
                        <input id="YoutubeLink" type="url" placeholder="Paste Youtube video link" class="flex-grow p-2 border border-gray-600 rounded-l-md">
                        <button id="Generateblogbutton" class="bg-blue-800 text-white px-4 py-2 rounded-r-md hover:bg-blue-900 transition-colors">Generate Article</button>
                    </div>
                    
                    <!-- AI Options -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-medium mb-3">ü§ñ AI Enhancement Options</h3>
                        
                        <!-- Writing Style -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Writing Style</label>
                                <select id="writingStyle" class="w-full p-2 border border-gray-300 rounded-md">
                                    <option value="default">Default</option>
                                    <option value="professional">Professional</option>
                                    <option value="casual">Casual & Friendly</option>
                                    <option value="academic">Academic</option>
                                    <option value="tutorial">Step-by-Step Tutorial</option>
                                    <option value="listicle">List Format</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Article Length</label>
                                <select id="articleLength" class="w-full p-2 border border-gray-300 rounded-md">
                                    <option value="medium">Medium (Default)</option>
                                    <option value="short">Short Summary</option>
                                    <option value="long">Detailed Article</option>
                                    <option value="comprehensive">Comprehensive Guide</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Custom Instructions -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Custom Instructions (Optional)</label>
                            <textarea id="customInstructions" 
                                      placeholder="e.g., Focus on beginner-friendly explanations, include code examples, emphasize practical tips..."
                                      class="w-full p-2 border border-gray-300 rounded-md h-20 resize-none"></textarea>
                        </div>
                        
                        <!-- AI Features Toggle -->
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="addSEO" class="mr-2">
                                <span class="text-sm">Add SEO Keywords</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="addSummary" class="mr-2">
                                <span class="text-sm">Include Summary</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="addTags" class="mr-2">
                                <span class="text-sm">Generate Tags</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading... section -->
             <div class="loader" id="loader"></div>
             
            <!-- Status Messages Section -->
            <div id="statusMessages" class="mt-6" style="display: none;">
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-md">
                    <div class="flex items-center mb-3">
                        <div class="flex-shrink-0">
                            <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                        <div class="ml-3 flex-grow">
                            <p id="statusText" class="text-sm font-medium text-blue-800">Processing...</p>
                            <p id="statusDetail" class="text-xs text-blue-600 mt-1"></p>
                        </div>
                    </div>
                    <!-- Progress Bar -->
                    <div class="w-full bg-blue-200 rounded-full h-2">
                        <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <p id="progressText" class="text-xs text-blue-600 mt-2 text-right">0%</p>
                </div>
            </div>

            <!-- Generated Blog Section -->
            <section class="mt-10 flex-grow">
                <h2 class="text-xl mb-4 font-semibold text-center">Generated Article</h2>
                <div id="blogcontent" class="mt-2 text-gray-700 space-y-4"></div>
                
                <!-- Original Transcript Section -->
                <div id="transcriptSection" class="mt-6 bg-gray-50 p-4 rounded-lg border border-gray-200" style="display: none;">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-medium">üìù Original Transcript</h3>
                        <button id="toggleTranscriptBtn" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            Show Transcript
                        </button>
                    </div>
                    <div id="transcriptContent" class="hidden bg-white p-4 rounded border border-gray-300 max-h-96 overflow-y-auto">
                        <p class="text-gray-700 whitespace-pre-wrap"></p>
                    </div>
                </div>
                
                <!-- AI Enhancement Tools -->
                <div id="aiToolsSection" class="mt-6 bg-blue-50 p-4 rounded-lg" style="display: none;">
                    <h3 class="text-lg font-medium mb-3">üöÄ AI Enhancement Tools</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <button id="improveBtn" class="bg-purple-600 text-white px-3 py-2 rounded-md hover:bg-purple-700 transition-colors text-sm">
                            ‚ú® Improve Writing
                        </button>
                        <button id="summarizeBtn" class="bg-indigo-600 text-white px-3 py-2 rounded-md hover:bg-indigo-700 transition-colors text-sm">
                            üìù Summarize
                        </button>
                        <button id="expandBtn" class="bg-orange-600 text-white px-3 py-2 rounded-md hover:bg-orange-700 transition-colors text-sm">
                            üìà Expand Content
                        </button>
                        <button id="seoBtn" class="bg-pink-600 text-white px-3 py-2 rounded-md hover:bg-pink-700 transition-colors text-sm">
                            üéØ SEO Optimize
                        </button>
                    </div>
                </div>
                
                <!-- Download Section -->
                <div id="downloadSection" class="mt-4 text-center" style="display: none;">
                    <button id="downloadBtn" class="inline-flex items-center bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Download as Text File
                    </button>
                </div>
            </section>

        </div>
    </div>

    <footer>
        <div class="bg-blue-800 text-white text-center p-4 mt-10">
            &copy; Powered by <a href="https://www.linkedin.com/in/mayank-goley-6a4372166/ " target="_blank">Mayank Goley</a>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const generateBtn = document.getElementById('Generateblogbutton');
            const youtubeLink = document.getElementById('YoutubeLink');
            const blogContent = document.getElementById('blogcontent');
            const loader = document.getElementById('loader');
            const downloadSection = document.getElementById('downloadSection');
            const downloadBtn = document.getElementById('downloadBtn');
            const statusMessages = document.getElementById('statusMessages');
            const statusText = document.getElementById('statusText');
            const statusDetail = document.getElementById('statusDetail');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            let currentBlogData = null;
            let processingStartTime = null;

            function showStatus(message, detail = '', progress = 0) {
                statusMessages.style.display = 'block';
                statusText.textContent = message;
                statusDetail.textContent = detail;
                updateProgress(progress);
            }

            function updateProgress(percent) {
                progressBar.style.width = percent + '%';
                progressText.textContent = Math.round(percent) + '%';
            }

            function hideStatus() {
                statusMessages.style.display = 'none';
                progressBar.style.width = '0%';
                progressText.textContent = '0%';
            }

            function showError(message) {
                blogContent.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-md">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800">Error</h3>
                                <p class="mt-2 text-sm text-red-700">${message}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            function updateElapsedTime() {
                if (processingStartTime) {
                    const elapsed = Math.floor((Date.now() - processingStartTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
                    return timeStr;
                }
                return '';
            }

            generateBtn.addEventListener('click', async function() {
                const link = youtubeLink.value.trim();
                
                if (!link) {
                    alert('Please enter a YouTube link');
                    return;
                }

                // Validate YouTube URL
                if (!link.includes('youtube.com') && !link.includes('youtu.be')) {
                    showError('Please enter a valid YouTube URL');
                    return;
                }

                // Reset UI
                loader.style.display = 'block';
                blogContent.innerHTML = '';
                downloadSection.style.display = 'none';
                document.getElementById('aiToolsSection').style.display = 'none';
                processingStartTime = Date.now();

                // Show initial status
                showStatus('Checking video...', 'Extracting video information', 5);

                // Progressive status updates with realistic timing and progress
                let currentStage = 0;
                let statusUpdateInterval = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - processingStartTime) / 1000);
                    const timeStr = elapsed > 60 ? `${Math.floor(elapsed/60)}m ${elapsed%60}s` : `${elapsed}s`;
                    
                    // Progress through stages based on elapsed time
                    if (elapsed > 3 && currentStage === 0) {
                        showStatus('Processing video...', 'Attempting to extract subtitles', 15);
                        currentStage = 1;
                    } else if (elapsed > 8 && currentStage === 1) {
                        showStatus('Downloading audio...', 'Downloading audio for transcription... (this may take a moment)', 30);
                        currentStage = 2;
                    } else if (elapsed > 15 && currentStage === 2) {
                        showStatus('Transcribing audio...', 'Transcribing audio (this may take a few minutes)...', 50);
                        currentStage = 3;
                    } else if (currentStage === 3) {
                        // Gradually increase progress during transcription, but cap at 95% to show activity
                        const transcriptionProgress = Math.min(95, 50 + (elapsed - 15) * 1.5);
                        statusDetail.textContent = `Transcribing audio (this may take a few minutes)... (${timeStr} elapsed)`;
                        updateProgress(transcriptionProgress);
                    } else if (currentStage === 2) {
                        statusDetail.textContent = `Downloading audio for transcription... (${timeStr} elapsed)`;
                        const downloadProgress = Math.min(45, 30 + (elapsed - 8) * 2);
                        updateProgress(downloadProgress);
                    }
                }, 1000);

                try {
                    const response = await fetch('/generate-blog', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            link: link,
                            writing_style: document.getElementById('writingStyle').value,
                            article_length: document.getElementById('articleLength').value,
                            custom_instructions: document.getElementById('customInstructions').value,
                            add_seo: document.getElementById('addSEO').checked,
                            add_summary: document.getElementById('addSummary').checked,
                            add_tags: document.getElementById('addTags').checked
                        })
                    });

                    clearInterval(statusUpdateInterval);
                    const data = await response.json();
                    
                    if (data.error) {
                        hideStatus();
                        
                        // Show detailed error message based on error type
                        let errorDetail = '';
                        let errorIcon = '‚ö†Ô∏è';
                        
                        if (data.error_type === 'duration_limit') {
                            errorDetail = 'Try a shorter video (under 60 minutes).';
                            errorIcon = '‚è±Ô∏è';
                        } else if (data.error_type === 'network_error') {
                            errorDetail = 'Please check your internet connection and try again.';
                            errorIcon = 'üåê';
                        } else if (data.error_type === 'invalid_url') {
                            errorDetail = 'Make sure the URL is correct and the video is publicly accessible.';
                            errorIcon = 'üîó';
                        } else if (data.error_type === 'timeout') {
                            errorDetail = 'The video took too long to process. Try a shorter video.';
                            errorIcon = '‚è±Ô∏è';
                        } else if (data.error_type === 'audio_extraction') {
                            errorDetail = 'Unable to extract audio from the video. The video may be private or unavailable.';
                            errorIcon = 'üéµ';
                        } else if (data.error_type === 'model_load') {
                            errorDetail = 'The transcription service is temporarily unavailable. Please try again later.';
                            errorIcon = 'üîß';
                        } else if (data.error_type === 'out_of_memory') {
                            errorDetail = 'The video is too large to process. Try a shorter video.';
                            errorIcon = 'üíæ';
                        } else if (data.error_type === 'disk_space') {
                            errorDetail = 'Server storage is full. Please contact the administrator.';
                            errorIcon = 'üíæ';
                        }
                        
                        let errorMessage = `<strong>${errorIcon} ${data.error}</strong>`;
                        if (errorDetail) {
                            errorMessage += `<br><br><span class="text-sm">üí° <strong>Suggestion:</strong> ${errorDetail}</span>`;
                        }
                        
                        showError(errorMessage);
                    } else {
                        // Show completion status briefly
                        showStatus('Generating article...', 'Finalizing content', 98);
                        
                        // Complete progress to 100%
                        setTimeout(() => {
                            updateProgress(100);
                            setTimeout(() => hideStatus(), 500);
                        }, 300);
                        
                        // Show success message with method used
                        let successMessage = '';
                        if (data.method === 'asr') {
                            const processingTime = data.transcription_info?.processing_time?.total || 0;
                            successMessage = `
                                <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-md mb-4">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <svg class="h-5 w-5 text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                        <div class="ml-3">
                                            <h3 class="text-sm font-medium text-green-800">Article Generated Successfully!</h3>
                                            <p class="mt-2 text-sm text-green-700">
                                                Audio transcribed using AI speech recognition
                                                ${data.transcription_info?.language ? ` (Language: ${data.transcription_info.language})` : ''}
                                                ${processingTime > 0 ? ` ‚Ä¢ Processing time: ${processingTime.toFixed(1)}s` : ''}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else if (data.method === 'subtitles') {
                            successMessage = `
                                <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-md mb-4">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <svg class="h-5 w-5 text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                        <div class="ml-3">
                                            <h3 class="text-sm font-medium text-green-800">Article Generated Successfully!</h3>
                                            <p class="mt-2 text-sm text-green-700">Generated from video subtitles</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        blogContent.innerHTML = successMessage + data.content;
                        currentBlogData = {
                            title: data.title || 'Generated Article',
                            content: data.content,
                            link: link,
                            transcript: data.transcript || '',
                            method: data.method
                        };
                        
                        // Show transcript section if transcript is available
                        if (data.transcript && data.transcript.trim().length > 0) {
                            const transcriptSection = document.getElementById('transcriptSection');
                            const transcriptContent = document.getElementById('transcriptContent').querySelector('p');
                            transcriptContent.textContent = data.transcript;
                            transcriptSection.style.display = 'block';
                        }
                        
                        // Show download and AI tools sections
                        downloadSection.style.display = 'block';
                        document.getElementById('aiToolsSection').style.display = 'block';
                    }
                } catch (error) {
                    clearInterval(statusUpdateInterval);
                    hideStatus();
                    showError('An error occurred while generating the blog. Please check your internet connection and try again.');
                    console.error('Error:', error);
                } finally {
                    // Hide loader
                    loader.style.display = 'none';
                    processingStartTime = null;
                }
            });

            // Handle download button click
            downloadBtn.addEventListener('click', function() {
                if (!currentBlogData) {
                    alert('No content to download');
                    return;
                }

                // Create text content
                const cleanContent = currentBlogData.content.replace(/<[^>]+>/g, '').replace(/\s+/g, ' ').trim();
                const now = new Date();
                const dateStr = now.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const textContent = `${currentBlogData.title}
${'='.repeat(currentBlogData.title.length)}

Generated on: ${dateStr}
Source Video: ${currentBlogData.link}

Article Content:
${'-'.repeat(50)}

${cleanContent}

${'-'.repeat(50)}
Generated by Article I - AI Blog Generator`;

                // Create and download file
                const blob = new Blob([textContent], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // Create safe filename
                const safeTitle = currentBlogData.title.replace(/[^\w\s-]/g, '').replace(/[-\s]+/g, '-');
                a.download = `${safeTitle.substring(0, 50)}-article.txt`;
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            });

            // AI Enhancement Tools
            document.getElementById('improveBtn').addEventListener('click', function() {
                enhanceContent('improve');
            });

            document.getElementById('summarizeBtn').addEventListener('click', function() {
                enhanceContent('summarize');
            });

            document.getElementById('expandBtn').addEventListener('click', function() {
                enhanceContent('expand');
            });

            document.getElementById('seoBtn').addEventListener('click', function() {
                enhanceContent('seo');
            });

            async function enhanceContent(type) {
                if (!currentBlogData) {
                    alert('No content to enhance');
                    return;
                }

                const button = document.getElementById(type + 'Btn');
                const originalText = button.textContent;
                button.textContent = 'Processing...';
                button.disabled = true;

                try {
                    const response = await fetch('/enhance-content', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            content: currentBlogData.content,
                            enhancement_type: type,
                            title: currentBlogData.title
                        })
                    });

                    const data = await response.json();
                    
                    if (data.error) {
                        alert('Enhancement failed: ' + data.error);
                    } else {
                        blogContent.innerHTML = data.enhanced_content;
                        currentBlogData.content = data.enhanced_content;
                        
                        // Show success message
                        const successMsg = document.createElement('div');
                        successMsg.className = 'bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4';
                        successMsg.textContent = `‚úì Content ${type}d successfully!`;
                        blogContent.insertBefore(successMsg, blogContent.firstChild);
                        
                        setTimeout(() => successMsg.remove(), 3000);
                    }
                } catch (error) {
                    alert('Enhancement failed. Please try again.');
                } finally {
                    button.textContent = originalText;
                    button.disabled = false;
                }
            }

            // Toggle transcript visibility
            const toggleTranscriptBtn = document.getElementById('toggleTranscriptBtn');
            const transcriptContent = document.getElementById('transcriptContent');
            
            toggleTranscriptBtn.addEventListener('click', function() {
                if (transcriptContent.classList.contains('hidden')) {
                    transcriptContent.classList.remove('hidden');
                    toggleTranscriptBtn.textContent = 'Hide Transcript';
                } else {
                    transcriptContent.classList.add('hidden');
                    toggleTranscriptBtn.textContent = 'Show Transcript';
                }
            });
        });
    </script>
    
</body>
</html>